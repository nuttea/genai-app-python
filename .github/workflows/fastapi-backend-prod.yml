name: FastAPI Backend Production Deploy

on:
  push:
    branches:
      - prod
    paths:
      - 'services/fastapi-backend/**'
      - '.github/workflows/fastapi-backend-prod.yml'

env:
  SERVICE_NAME: genai-fastapi-backend
  REGION: us-central1
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Quality Gate - Lint
    uses: ./.github/workflows/_reusable-python-lint.yml
    with:
      working_directory: 'services/fastapi-backend'
      python_version: '3.11'
      black_path: 'app/'
      ruff_path: 'app/'
      sync_extras: '--all-extras'

  deploy:
    name: Deploy to Production
    needs: [lint]
    uses: ./.github/workflows/_reusable-cloudrun-deploy.yml
    with:
      service_name: genai-fastapi-backend
      region: us-central1
      dockerfile_path: services/fastapi-backend/Dockerfile.cloudrun
      docker_context: services/fastapi-backend
      deployment_tag: prod
      no_traffic: true
      environment: prod
      memory: 2Gi
      cpu: '2'
      timeout: '300'
      max_instances: '1'
      min_instances: '0'
      port: '8000'
      env_vars: |
        DD_ENV=prod
        DD_SERVICE=genai-fastapi-backend
        DD_VERSION=${{ github.sha }}
        DD_LOGS_INJECTION=true
        DD_TRACE_ENABLED=true
        DD_RUNTIME_METRICS_ENABLED=true
        DD_PROFILING_ENABLED=true
        DD_TRACE_SAMPLE_RATE=1
        DD_PROFILING_HEAP_ENABLED=true
        DD_PROFILING_MEMORY_ENABLED=true
        ENVIRONMENT=production
        LOG_LEVEL=INFO
        ALLOWED_ORIGINS=*
      secrets: |
        DD_API_KEY=DD_API_KEY:latest
        API_KEY=api-key:latest
        GEMINI_API_KEY=gemini-api-key:latest
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

