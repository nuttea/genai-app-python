name: Streamlit Frontend CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'frontend/streamlit/**'
      - '.github/workflows/streamlit-frontend.yml'
  pull_request:
    paths:
      - 'frontend/streamlit/**'
      - '.github/workflows/streamlit-frontend.yml'
  workflow_dispatch:

env:
  SERVICE_NAME: genai-streamlit-frontend
  REGION: us-central1
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Lint Frontend
    # Skip lint on main branch pushes (only lint PRs and develop branch)
    if: github.event_name == 'pull_request' || github.ref != 'refs/heads/main'
    uses: ./.github/workflows/_reusable-python-lint.yml
    with:
      working_directory: frontend/streamlit
      python_version: '3.11'
      run_black: true
      run_ruff: true
      black_path: '.'
      ruff_path: '.'
      sync_extras: '--all-extras --no-install-project'

  get-backend-url:
    name: Get Backend URL
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write
    outputs:
      backend_url: ${{ steps.get-backend-url.outputs.url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Backend URL
        id: get-backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe genai-fastapi-backend \
            --region ${{ env.REGION }} \
            --format 'value(status.url)' 2>/dev/null || echo "")
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"

  deploy:
    name: Deploy to Cloud Run
    needs: [get-backend-url]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/_reusable-cloudrun-deploy.yml
    with:
      service_name: genai-streamlit-frontend
      region: us-central1
      dockerfile_path: frontend/streamlit/Dockerfile
      docker_context: frontend/streamlit
      port: '8501'
      memory: '1Gi'
      cpu: '1'
      timeout: '300'
      max_instances: '10'
      min_instances: '0'
      environment: 'dev'
      env_vars: |
        API_BASE_URL=${{ needs.get-backend-url.outputs.backend_url }}
        FASTAPI_ENV=production
        DD_SITE=datadoghq.com
        DD_SERVICE=genai-streamlit-frontend
        DD_ENV=dev
        DD_VERSION=${{ github.sha }}
        DD_LOGS_ENABLED=true
        DD_LOGS_INJECTION=true
        DD_SOURCE=python
        DD_TRACE_SAMPLE_RATE=1.0
        DD_PROFILING_ENABLED=true
        DD_CODE_ORIGIN_FOR_SPANS_ENABLED=true
        DD_RUM_CLIENT_TOKEN=${{ vars.DD_RUM_CLIENT_TOKEN }}
        DD_RUM_APPLICATION_ID=${{ vars.DD_RUM_APPLICATION_ID }}
      secrets: |
        API_KEY=api-key:latest
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

  smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Test Frontend Accessibility
        run: |
          FRONTEND_URL="${{ needs.deploy.outputs.service_url }}"
          
          # Test frontend is accessible
          echo "Testing frontend at: $FRONTEND_URL"
          curl -f "${FRONTEND_URL}" || exit 1
          
          echo "âœ… Smoke tests passed"
