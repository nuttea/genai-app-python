name: Streamlit Frontend Production Deploy

on:
  push:
    branches:
      - prod
    paths:
      - 'frontend/streamlit/**'
      - '.github/workflows/streamlit-frontend-prod.yml'

env:
  SERVICE_NAME: genai-streamlit-frontend
  REGION: us-central1
  PYTHON_VERSION: '3.11'

jobs:
  get-backend-url:
    name: Get Backend Production URL
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'
    permissions:
      contents: read
      id-token: write
    outputs:
      backend_url: ${{ steps.get-backend-url.outputs.url }}

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Backend Production URL
        id: get-backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe genai-fastapi-backend \
            --region ${{ env.REGION }} \
            --format 'value(status.traffic[0].url)' 2>/dev/null || echo "")
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend Production URL: $BACKEND_URL"

  deploy:
    name: Deploy to Production
    needs: [get-backend-url]
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'
    uses: ./.github/workflows/_reusable-cloudrun-deploy.yml
    with:
      service_name: genai-streamlit-frontend
      region: us-central1
      dockerfile_path: frontend/streamlit/Dockerfile
      docker_context: frontend/streamlit
      deployment_tag: 'prod'
      no_traffic: true
      port: '8501'
      memory: '1Gi'
      cpu: '1'
      timeout: '300'
      max_instances: '10'
      min_instances: '0'
      environment: 'prod'
      env_vars: |
        API_BASE_URL=${{ needs.get-backend-url.outputs.backend_url }}
        FASTAPI_ENV=production
        DD_SITE=datadoghq.com
        DD_SERVICE=genai-streamlit-frontend
        DD_ENV=prod
        DD_VERSION=${{ github.sha }}
        DD_LOGS_ENABLED=true
        DD_LOGS_INJECTION=true
        DD_SOURCE=python
        DD_TRACE_SAMPLE_RATE=1.0
        DD_PROFILING_ENABLED=true
        DD_CODE_ORIGIN_FOR_SPANS_ENABLED=true
        DD_RUM_CLIENT_TOKEN=${{ vars.DD_RUM_CLIENT_TOKEN }}
        DD_RUM_APPLICATION_ID=${{ vars.DD_RUM_APPLICATION_ID }}
      secrets: |
        API_KEY=api-key:latest
    secrets:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

  smoke-tests:
    name: Run Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'

    steps:
      - name: Test Production Frontend
        run: |
          PROD_URL="${{ needs.deploy.outputs.service_url }}"
          
          echo "Testing production frontend at: $PROD_URL"
          
          # Test Streamlit health endpoint
          curl -f "${PROD_URL}/_stcore/health" || exit 1
          
          echo "âœ… Production smoke tests passed"

  deployment-summary:
    name: Create Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy, smoke-tests]
    if: github.ref == 'refs/heads/prod' && github.event_name == 'push'

    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: prod" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ needs.deploy.outputs.service_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployed with tag: \`prod\` (no traffic)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "To route traffic to this revision:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gcloud run services update-traffic ${{ env.SERVICE_NAME }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --to-tags prod=100 \\" >> $GITHUB_STEP_SUMMARY
          echo "  --region ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
